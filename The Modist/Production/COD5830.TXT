OBJECT Codeunit 5830 Calc. Availability Overview
{
  OBJECT-PROPERTIES
  {
    Date=15/09/15;
    Time=12:00:00 PM;
    Version List=NAVW19.00;
  }
  PROPERTIES
  {
    TableNo=5830;
    OnRun=VAR
            CopyOfAvailabilityCalcOverview@1000 : Record 5830;
          BEGIN
            CopyOfAvailabilityCalcOverview.COPY(Rec);
            RESET;
            DELETEALL;
            COPY(CopyOfAvailabilityCalcOverview);

            OpenWindow(Text000,COUNT);

            Item.RESET;
            Item.SETFILTER("No.",CopyOfAvailabilityCalcOverview.GETFILTER("Item No."));
            Item.SETFILTER("Location Filter",GETFILTER("Location Code"));
            Item.SETFILTER("Variant Filter",GETFILTER("Variant Code"));
            Item.SETFILTER("Date Filter",GETFILTER(Date));
            Item.SETRANGE("Drop Shipment Filter",FALSE);
            Item.SETRANGE(Type,Item.Type::Inventory);
            IF Item.FIND('-') THEN BEGIN
              OpenWindow(Text000,Item.COUNT);
              REPEAT
                UpdateWindow;
                SETRANGE("Matches Criteria");
                "Item No." := Item."No.";
                IF CheckItemInRange(Rec) AND EntriesExist(Rec) THEN BEGIN
                  RESET;
                  IF FINDLAST THEN;
                  SetEntryNo("Entry No.");
                  InsertEntry(Rec,Type::Item,0D,'','',0,0,0,0,'',Item.Description,0);
                END;
                COPY(CopyOfAvailabilityCalcOverview);
              UNTIL Item.NEXT = 0;
            END;
            Window.CLOSE;
          END;

  }
  CODE
  {
    VAR
      Item@1000 : Record 27;
      Window@1005 : Dialog;
      StartDate@1009 : Date;
      EndDate@1010 : Date;
      AttachedToEntryNo@1001 : Integer;
      EntryNo@1002 : Integer;
      DemandType@1003 : ' ,Sales,Production,Job,Service,Assembly';
      DemandNo@1014 : Code[20];
      WindowUpdateDateTime@1006 : DateTime;
      NoOfRecords@1007 : Integer;
      i@1008 : Integer;
      Text000@1004 : TextConst 'ENU=Calculating Availability Dates @1@@@@@@@;ENG=Calculating Availability Dates @1@@@@@@@';

    PROCEDURE CalculateItem@1035(VAR AvailabilityCalcOverview@1000 : Record 5830);
    VAR
      CopyOfAvailabilityCalcOverview@1001 : Record 5830;
      CopyOfItem@1002 : Record 27;
      FirstEntryNo@1003 : Integer;
    BEGIN
      CopyOfItem.COPY(Item);
      CopyOfAvailabilityCalcOverview.COPY(AvailabilityCalcOverview);
      WITH AvailabilityCalcOverview DO BEGIN
        StartDate := 0D;
        EndDate := 31129999D;
        IF GETFILTER(Date) <> '' THEN BEGIN
          StartDate := GETRANGEMIN(Date);
          EndDate := GETRANGEMAX(Date);
        END;

        Item.RESET;
        Item.SETFILTER("No.",CopyOfAvailabilityCalcOverview.GETFILTER("Item No."));
        Item.SETFILTER("Location Filter",GETFILTER("Location Code"));
        Item.SETFILTER("Variant Filter",GETFILTER("Variant Code"));
        Item.SETRANGE("Drop Shipment Filter",FALSE);

        SETRANGE("Matches Criteria");
        Item.GET("Item No.");
        RESET;
        SETCURRENTKEY("Item No.");
        SETRANGE("Item No.",Item."No.");
        DELETEALL;

        RESET;
        IF FINDLAST THEN;
        SetEntryNo("Entry No.");

        InsertEntry(AvailabilityCalcOverview,Type::Item,0D,'','',0,0,0,0,'',Item.Description,0);
        CopyOfAvailabilityCalcOverview := AvailabilityCalcOverview;

        FirstEntryNo := "Entry No.";
        COPYFILTERS(CopyOfAvailabilityCalcOverview);
        GetInventoryDates(AvailabilityCalcOverview);
        GetSupplyDates(AvailabilityCalcOverview);
        GetDemandDates(AvailabilityCalcOverview);

        RESET;
        SETCURRENTKEY("Item No.");
        SETRANGE("Item No.",Item."No.");
        SETFILTER(Date,CopyOfAvailabilityCalcOverview.GETFILTER(Date));
        SETFILTER("Location Code",CopyOfAvailabilityCalcOverview.GETFILTER("Location Code"));
        SETFILTER("Variant Code",CopyOfAvailabilityCalcOverview.GETFILTER("Variant Code"));
        IF NOT FINDFIRST THEN BEGIN
          SETRANGE(Date);
          SETRANGE("Location Code");
          SETRANGE("Variant Code");
          DELETEALL;
        END ELSE
          IF DemandType = DemandType::" " THEN
            MODIFYALL("Matches Criteria",TRUE);
        RESET;
        IF GET(FirstEntryNo) THEN
          IF NEXT = 0 THEN
            DELETE;
      END;
      Item.COPY(CopyOfItem);
      AvailabilityCalcOverview.COPY(CopyOfAvailabilityCalcOverview);
    END;

    PROCEDURE CalculateDate@1000(VAR AvailabilityCalcOverview@1000 : Record 5830);
    VAR
      CopyOfAvailabilityCalcOverview@1001 : Record 5830;
      FirstEntryNo@1007 : Integer;
    BEGIN
      CopyOfAvailabilityCalcOverview.COPY(AvailabilityCalcOverview);
      AttachedToEntryNo := AvailabilityCalcOverview."Attached to Entry No.";

      WITH AvailabilityCalcOverview DO BEGIN
        Item.GET("Item No.");

        RESET;
        SETRANGE("Item No.","Item No.");
        SETRANGE("Location Code","Location Code");
        SETRANGE("Variant Code","Variant Code");
        SETRANGE(Date,Date);
        SETRANGE(Level,2,3);
        DELETEALL;

        RESET;
        IF FINDLAST THEN;
        SetEntryNo("Entry No.");
        TRANSFERFIELDS(CopyOfAvailabilityCalcOverview,FALSE);
        FirstEntryNo := "Entry No.";
      END;

      Item.SETRANGE("Location Filter",AvailabilityCalcOverview."Location Code");
      Item.SETRANGE("Variant Filter",AvailabilityCalcOverview."Variant Code");
      Item.SETRANGE("Date Filter",AvailabilityCalcOverview.Date);
      GetSupplyEntries(AvailabilityCalcOverview);
      GetDemandEntries(AvailabilityCalcOverview);

      AvailabilityCalcOverview.GET(FirstEntryNo);
      IF AvailabilityCalcOverview.NEXT = 0 THEN;
      UpdateRunningTotals(AvailabilityCalcOverview);

      AvailabilityCalcOverview.GET(FirstEntryNo);
      IF AvailabilityCalcOverview.NEXT = 0 THEN;
    END;

    LOCAL PROCEDURE GetInventoryDates@1002(VAR AvailabilityCalcOverview@1000 : Record 5830);
    VAR
      ItemLedgEntry@1001 : Record 32;
    BEGIN
      WITH ItemLedgEntry DO BEGIN
        FilterLinesWithItemToPlan(Item,FALSE);
        IF FINDFIRST THEN
          REPEAT
            SETRANGE("Location Code","Location Code");
            SETRANGE("Variant Code","Variant Code");
            CALCSUMS("Remaining Quantity");
            SETRANGE(Positive,Positive);
            InsertEntry(
              AvailabilityCalcOverview,
              AvailabilityCalcOverview.Type::Inventory,0D,"Location Code","Variant Code",
              "Remaining Quantity",0,
              0,0,'','',0);

            FINDLAST;
            SETFILTER("Location Code",AvailabilityCalcOverview.GETFILTER("Location Code"));
            SETFILTER("Variant Code",AvailabilityCalcOverview.GETFILTER("Variant Code"));
            SETRANGE(Positive);
          UNTIL NEXT = 0;
      END;
    END;

    LOCAL PROCEDURE GetSupplyDates@1022(VAR AvailabilityCalcOverview@1000 : Record 5830);
    BEGIN
      GetPurchOrderSupplyDates(AvailabilityCalcOverview);
      GetSalesRetOrderSupplyDates(AvailabilityCalcOverview);
      GetProdOrderSupplyDates(AvailabilityCalcOverview);
      GetTransOrderSupplyDates(AvailabilityCalcOverview);
      GetAsmOrderSupplyDates(AvailabilityCalcOverview);
    END;

    LOCAL PROCEDURE GetDemandDates@1023(VAR AvailabilityCalcOverview@1000 : Record 5830);
    BEGIN
      GetSalesOrdersDemandDates(AvailabilityCalcOverview);
      GetServOrdersDemandDates(AvailabilityCalcOverview);
      GetJobOrdersDemandDates(AvailabilityCalcOverview);
      GetPurchRetOrderDemandDates(AvailabilityCalcOverview);
      GetProdOrderCompDemandDates(AvailabilityCalcOverview);
      GetTransOrderDemandDates(AvailabilityCalcOverview);
      GetAsmOrderDemandDates(AvailabilityCalcOverview);
    END;

    LOCAL PROCEDURE GetSupplyEntries@1020(VAR AvailabilityCalcOverview@1000 : Record 5830);
    VAR
      CopyOfItem@1001 : Record 27;
    BEGIN
      CopyOfItem.COPY(Item);
      Item.SETRANGE("Location Filter",AvailabilityCalcOverview."Location Code");
      Item.SETRANGE("Variant Filter",AvailabilityCalcOverview."Variant Code");
      Item.SETRANGE("Date Filter",AvailabilityCalcOverview.Date);

      GetPurchOrderSupplyEntries(AvailabilityCalcOverview);
      GetSalesRetOrderSupplyEntries(AvailabilityCalcOverview);
      GetProdOrderSupplyEntries(AvailabilityCalcOverview);
      GetTransOrderSupplyEntries(AvailabilityCalcOverview);
      GetAsmOrderSupplyEntries(AvailabilityCalcOverview);

      Item.COPY(CopyOfItem);
    END;

    LOCAL PROCEDURE GetDemandEntries@1024(VAR AvailabilityCalcOverview@1000 : Record 5830);
    VAR
      CopyOfItem@1001 : Record 27;
    BEGIN
      CopyOfItem.COPY(Item);
      Item.SETRANGE("Location Filter",AvailabilityCalcOverview."Location Code");
      Item.SETRANGE("Variant Filter",AvailabilityCalcOverview."Variant Code");
      Item.SETRANGE("Date Filter",AvailabilityCalcOverview.Date);

      GetSalesOrdersDemandEntries(AvailabilityCalcOverview);
      GetServOrdersDemandEntries(AvailabilityCalcOverview);
      GetJobOrdersDemandEntries(AvailabilityCalcOverview);
      GetPurchRetOrderDemandEntries(AvailabilityCalcOverview);
      GetProdOrderCompDemandEntries(AvailabilityCalcOverview);
      GetTransOrderDemandEntries(AvailabilityCalcOverview);
      GetAsmOrderDemandEntries(AvailabilityCalcOverview);

      Item.COPY(Item);
    END;

    PROCEDURE EntriesExist@1(VAR AvailabilityCalcOverview@1000 : Record 5830) : Boolean;
    VAR
      Item@1001 : Record 27;
    BEGIN
      Item.GET(AvailabilityCalcOverview."Item No.");
      Item.SETFILTER("Location Filter",AvailabilityCalcOverview.GETFILTER("Location Code"));
      Item.SETFILTER("Variant Filter",AvailabilityCalcOverview.GETFILTER("Variant Code"));
      Item.SETFILTER("Date Filter",AvailabilityCalcOverview.GETFILTER(Date));

      EXIT(TRUE IN
        [InventoryExists(Item),
         SupplyExists(Item),
         DemandExists(Item)]);
    END;

    LOCAL PROCEDURE InventoryExists@1033(VAR Item@1000 : Record 27) : Boolean;
    VAR
      ItemLedgEntry@1001 : Record 32;
    BEGIN
      EXIT(ItemLedgEntry.LinesWithItemToPlanExist(Item,FALSE));
    END;

    LOCAL PROCEDURE SupplyExists@1032(VAR Item@1000 : Record 27) : Boolean;
    BEGIN
      EXIT(TRUE IN
        [PurchOrderSupplyExists(Item),
         SalesRetOrderSupplyExists(Item),
         ProdOrderSupplyExists(Item),
         TransOrderSupplyExists(Item),
         AsmOrderSupplyExists(Item)]);
    END;

    LOCAL PROCEDURE DemandExists@1031(VAR Item@1000 : Record 27) : Boolean;
    BEGIN
      EXIT(TRUE IN
        [SalesOrderDemandExists(Item),
         ServOrderDemandExists(Item),
         JobOrderDemandExists(Item),
         PurchRetOrderDemandExists(Item),
         ProdOrderCompDemandExists(Item),
         TransOrderDemandExists(Item),
         AsmOrderDemandExists(Item)]);
    END;

    LOCAL PROCEDURE GetPurchOrderSupplyDates@1003(VAR AvailabilityCalcOverview@1000 : Record 5830);
    VAR
      PurchLine@1001 : Record 39;
    BEGIN
      WITH PurchLine DO BEGIN
        FilterLinesWithItemToPlan(Item,"Document Type"::Order);
        IF FINDFIRST THEN
          REPEAT
            SETRANGE("Location Code","Location Code");
            SETRANGE("Variant Code","Variant Code");
            SETRANGE("Expected Receipt Date","Expected Receipt Date");

            InsertEntry(
              AvailabilityCalcOverview,
              AvailabilityCalcOverview.Type::"As of Date","Expected Receipt Date","Location Code","Variant Code",0,0,0,0,'','',0);

            FINDLAST;
            SETFILTER("Location Code",Item.GETFILTER("Location Filter"));
            SETFILTER("Variant Code",Item.GETFILTER("Variant Filter"));
            SETFILTER("Expected Receipt Date",Item.GETFILTER("Date Filter"));
          UNTIL NEXT = 0;
      END;
    END;

    LOCAL PROCEDURE GetSalesRetOrderSupplyDates@1006(VAR AvailabilityCalcOverview@1000 : Record 5830);
    VAR
      SalesLine@1001 : Record 37;
    BEGIN
      WITH SalesLine DO BEGIN
        FilterLinesWithItemToPlan(Item,"Document Type"::"Return Order");
        IF FINDFIRST THEN
          REPEAT
            SETRANGE("Location Code","Location Code");
            SETRANGE("Variant Code","Variant Code");
            SETRANGE("Shipment Date","Shipment Date");

            InsertEntry(
              AvailabilityCalcOverview,
              AvailabilityCalcOverview.Type::"As of Date","Shipment Date","Location Code","Variant Code",0,0,0,0,'','',0);

            FINDLAST;
            SETFILTER("Location Code",Item.GETFILTER("Location Filter"));
            SETFILTER("Variant Code",Item.GETFILTER("Variant Filter"));
            SETFILTER("Shipment Date",Item.GETFILTER("Date Filter"));
          UNTIL NEXT = 0;
      END;
    END;

    LOCAL PROCEDURE GetProdOrderSupplyDates@1007(VAR AvailabilityCalcOverview@1000 : Record 5830);
    VAR
      ProdOrderLine@1001 : Record 5406;
    BEGIN
      WITH ProdOrderLine DO BEGIN
        FilterLinesWithItemToPlan(Item,TRUE);
        IF FINDFIRST THEN
          REPEAT
            SETRANGE("Location Code","Location Code");
            SETRANGE("Variant Code","Variant Code");
            SETRANGE("Due Date","Due Date");

            InsertEntry(
              AvailabilityCalcOverview,
              AvailabilityCalcOverview.Type::"As of Date","Due Date","Location Code","Variant Code",0,0,0,0,'','',0);

            FINDLAST;
            SETFILTER("Location Code",Item.GETFILTER("Location Filter"));
            SETFILTER("Variant Code",Item.GETFILTER("Variant Filter"));
            SETFILTER("Due Date",Item.GETFILTER("Date Filter"));
          UNTIL NEXT = 0;
      END;
    END;

    LOCAL PROCEDURE GetTransOrderSupplyDates@1009(VAR AvailabilityCalcOverview@1000 : Record 5830);
    VAR
      TransLine@1001 : Record 5741;
    BEGIN
      WITH TransLine DO BEGIN
        FilterLinesWithItemToPlan(Item,TRUE,FALSE);
        IF FINDFIRST THEN
          REPEAT
            SETRANGE("Transfer-to Code","Transfer-to Code");
            SETRANGE("Variant Code","Variant Code");
            SETRANGE("Receipt Date","Receipt Date");

            InsertEntry(
              AvailabilityCalcOverview,
              AvailabilityCalcOverview.Type::"As of Date","Receipt Date","Transfer-to Code","Variant Code",0,0,0,0,'','',0);

            FINDLAST;
            SETFILTER("Transfer-to Code",Item.GETFILTER("Location Filter"));
            SETFILTER("Variant Code",Item.GETFILTER("Variant Filter"));
            SETFILTER("Receipt Date",Item.GETFILTER("Date Filter"));
          UNTIL NEXT = 0;
      END;
    END;

    LOCAL PROCEDURE GetSalesOrdersDemandDates@1004(VAR AvailabilityCalcOverview@1000 : Record 5830);
    VAR
      SalesLine@1001 : Record 37;
    BEGIN
      WITH SalesLine DO BEGIN
        FilterLinesWithItemToPlan(Item,"Document Type"::Order);
        IF FINDFIRST THEN
          REPEAT
            SETRANGE("Location Code","Location Code");
            SETRANGE("Variant Code","Variant Code");
            SETRANGE("Shipment Date","Shipment Date");

            InsertEntry(
              AvailabilityCalcOverview,
              AvailabilityCalcOverview.Type::"As of Date","Shipment Date","Location Code","Variant Code",0,0,0,0,'','',0);

            FINDLAST;
            SETFILTER("Location Code",Item.GETFILTER("Location Filter"));
            SETFILTER("Variant Code",Item.GETFILTER("Variant Filter"));
            SETFILTER("Shipment Date",Item.GETFILTER("Date Filter"));
          UNTIL NEXT = 0;
      END;
    END;

    LOCAL PROCEDURE GetServOrdersDemandDates@11(VAR AvailabilityCalcOverview@1000 : Record 5830);
    VAR
      ServLine@1001 : Record 5902;
    BEGIN
      WITH ServLine DO BEGIN
        FilterLinesWithItemToPlan(Item);
        IF FINDFIRST THEN
          REPEAT
            SETRANGE("Location Code","Location Code");
            SETRANGE("Variant Code","Variant Code");
            SETRANGE("Needed by Date","Needed by Date");

            InsertEntry(
              AvailabilityCalcOverview,
              AvailabilityCalcOverview.Type::"As of Date","Needed by Date","Location Code","Variant Code",0,0,0,0,'','',0);

            FINDLAST;
            SETFILTER("Location Code",Item.GETFILTER("Location Filter"));
            SETFILTER("Variant Code",Item.GETFILTER("Variant Filter"));
            SETFILTER("Needed by Date",Item.GETFILTER("Date Filter"));
          UNTIL NEXT = 0;
      END;
    END;

    LOCAL PROCEDURE GetJobOrdersDemandDates@10(VAR AvailabilityCalcOverview@1000 : Record 5830);
    VAR
      JobPlanningLine@1001 : Record 1003;
    BEGIN
      WITH JobPlanningLine DO BEGIN
        FilterLinesWithItemToPlan(Item);
        IF FINDFIRST THEN
          REPEAT
            SETRANGE("Location Code","Location Code");
            SETRANGE("Variant Code","Variant Code");
            SETRANGE("Planning Date","Planning Date");

            InsertEntry(
              AvailabilityCalcOverview,
              AvailabilityCalcOverview.Type::"As of Date","Planning Date","Location Code","Variant Code",0,0,0,0,'','',0);

            FINDLAST;
            SETFILTER("Location Code",Item.GETFILTER("Location Filter"));
            SETFILTER("Variant Code",Item.GETFILTER("Variant Filter"));
            SETFILTER("Planning Date",Item.GETFILTER("Date Filter"));
          UNTIL NEXT = 0;
      END;
    END;

    LOCAL PROCEDURE GetPurchRetOrderDemandDates@1005(VAR AvailabilityCalcOverview@1000 : Record 5830);
    VAR
      PurchLine@1001 : Record 39;
    BEGIN
      WITH PurchLine DO BEGIN
        FilterLinesWithItemToPlan(Item,"Document Type"::"Return Order");
        IF FINDFIRST THEN
          REPEAT
            SETRANGE("Location Code","Location Code");
            SETRANGE("Variant Code","Variant Code");
            SETRANGE("Expected Receipt Date","Expected Receipt Date");

            InsertEntry(
              AvailabilityCalcOverview,
              AvailabilityCalcOverview.Type::"As of Date","Expected Receipt Date","Location Code","Variant Code",0,0,0,0,'','',0);

            FINDLAST;
            SETFILTER("Location Code",Item.GETFILTER("Location Filter"));
            SETFILTER("Variant Code",Item.GETFILTER("Variant Filter"));
            SETFILTER("Expected Receipt Date",Item.GETFILTER("Date Filter"));
          UNTIL NEXT = 0;
      END;
    END;

    LOCAL PROCEDURE GetProdOrderCompDemandDates@1008(VAR AvailabilityCalcOverview@1000 : Record 5830);
    VAR
      ProdOrderComp@1001 : Record 5407;
    BEGIN
      WITH ProdOrderComp DO BEGIN
        FilterLinesWithItemToPlan(Item,TRUE);
        IF FINDFIRST THEN
          REPEAT
            SETRANGE("Location Code","Location Code");
            SETRANGE("Variant Code","Variant Code");
            SETRANGE("Due Date","Due Date");

            InsertEntry(
              AvailabilityCalcOverview,
              AvailabilityCalcOverview.Type::"As of Date","Due Date","Location Code","Variant Code",0,0,0,0,'','',0);

            FINDLAST;
            SETFILTER("Location Code",Item.GETFILTER("Location Filter"));
            SETFILTER("Variant Code",Item.GETFILTER("Variant Filter"));
            SETFILTER("Due Date",Item.GETFILTER("Date Filter"));
          UNTIL NEXT = 0;
      END;
    END;

    LOCAL PROCEDURE GetTransOrderDemandDates@1010(VAR AvailabilityCalcOverview@1000 : Record 5830);
    VAR
      TransLine@1001 : Record 5741;
    BEGIN
      WITH TransLine DO BEGIN
        FilterLinesWithItemToPlan(Item,FALSE,FALSE);
        IF FINDFIRST THEN
          REPEAT
            SETRANGE("Transfer-from Code","Transfer-from Code");
            SETRANGE("Variant Code","Variant Code");
            SETRANGE("Shipment Date","Shipment Date");

            InsertEntry(
              AvailabilityCalcOverview,
              AvailabilityCalcOverview.Type::"As of Date","Shipment Date","Transfer-from Code","Variant Code",0,0,0,0,'','',0);

            FINDLAST;
            SETFILTER("Transfer-to Code",Item.GETFILTER("Location Filter"));
            SETFILTER("Variant Code",Item.GETFILTER("Variant Filter"));
            SETFILTER("Shipment Date",Item.GETFILTER("Date Filter"));
          UNTIL NEXT = 0;
      END;
    END;

    LOCAL PROCEDURE GetAsmOrderDemandDates@13(VAR AvailabilityCalcOverview@1000 : Record 5830);
    VAR
      AsmLine@1001 : Record 901;
    BEGIN
      WITH AsmLine DO BEGIN
        FilterLinesWithItemToPlan(Item,"Document Type"::Order);
        IF FINDFIRST THEN
          REPEAT
            SETRANGE("Location Code","Location Code");
            SETRANGE("Variant Code","Variant Code");
            SETRANGE("Due Date","Due Date");

            InsertEntry(
              AvailabilityCalcOverview,
              AvailabilityCalcOverview.Type::"As of Date","Due Date","Location Code","Variant Code",0,0,0,0,'','',0);

            FINDLAST;
            SETFILTER("Location Code",Item.GETFILTER("Location Filter"));
            SETFILTER("Variant Code",Item.GETFILTER("Variant Filter"));
            SETFILTER("Due Date",Item.GETFILTER("Date Filter"));
          UNTIL NEXT = 0;
      END;
    END;

    LOCAL PROCEDURE GetAsmOrderSupplyDates@9(VAR AvailabilityCalcOverview@1000 : Record 5830);
    VAR
      AsmHeader@1001 : Record 900;
    BEGIN
      WITH AsmHeader DO BEGIN
        FilterLinesWithItemToPlan(Item,"Document Type"::Order);
        IF FINDFIRST THEN
          REPEAT
            SETRANGE("Location Code","Location Code");
            SETRANGE("Variant Code","Variant Code");
            SETRANGE("Due Date","Due Date");

            InsertEntry(
              AvailabilityCalcOverview,
              AvailabilityCalcOverview.Type::"As of Date","Due Date","Location Code","Variant Code",0,0,0,0,'','',0);

            FINDLAST;
            SETFILTER("Location Code",Item.GETFILTER("Location Filter"));
            SETFILTER("Variant Code",Item.GETFILTER("Variant Filter"));
            SETFILTER("Due Date",Item.GETFILTER("Date Filter"));
          UNTIL NEXT = 0;
      END;
    END;

    LOCAL PROCEDURE GetPurchOrderSupplyEntries@1018(VAR AvailabilityCalcOverview@1000 : Record 5830);
    VAR
      PurchLine@1001 : Record 39;
      PurchHeader@1002 : Record 38;
    BEGIN
      WITH PurchLine DO BEGIN
        IF FindLinesWithItemToPlan(Item,"Document Type"::Order) THEN
          REPEAT
            PurchHeader.GET("Document Type","Document No.");
            CALCFIELDS("Reserved Qty. (Base)");
            InsertEntry(
              AvailabilityCalcOverview,
              AvailabilityCalcOverview.Type::Supply,"Expected Receipt Date","Location Code","Variant Code",
              "Outstanding Qty. (Base)","Reserved Qty. (Base)",
              DATABASE::"Purchase Line","Document Type","Document No.",PurchHeader."Buy-from Vendor Name",0);
          UNTIL NEXT = 0;
      END;
    END;

    LOCAL PROCEDURE GetSalesRetOrderSupplyEntries@1015(VAR AvailabilityCalcOverview@1000 : Record 5830);
    VAR
      SalesLine@1001 : Record 37;
      SalesHeader@1002 : Record 36;
    BEGIN
      WITH SalesLine DO BEGIN
        IF FindLinesWithItemToPlan(Item,"Document Type"::"Return Order") THEN
          REPEAT
            SalesHeader.GET("Document Type","Document No.");
            CALCFIELDS("Reserved Qty. (Base)");
            InsertEntry(
              AvailabilityCalcOverview,
              AvailabilityCalcOverview.Type::Supply,"Shipment Date","Location Code","Variant Code",
              "Outstanding Qty. (Base)","Reserved Qty. (Base)",
              DATABASE::"Sales Line","Document Type","Document No.",SalesHeader."Sell-to Customer Name",0);
          UNTIL NEXT = 0;
      END;
    END;

    LOCAL PROCEDURE GetProdOrderSupplyEntries@1014(VAR AvailabilityCalcOverview@1000 : Record 5830);
    VAR
      ProdOrderLine@1001 : Record 5406;
      ProdOrder@1002 : Record 5405;
    BEGIN
      WITH ProdOrderLine DO BEGIN
        IF FindLinesWithItemToPlan(Item,TRUE) THEN
          REPEAT
            ProdOrder.GET(Status,"Prod. Order No.");
            CALCFIELDS("Reserved Qty. (Base)");
            InsertEntry(
              AvailabilityCalcOverview,
              AvailabilityCalcOverview.Type::Supply,"Due Date","Location Code","Variant Code",
              "Remaining Qty. (Base)","Reserved Qty. (Base)",
              DATABASE::"Prod. Order Line",Status,"Prod. Order No.",ProdOrder.Description,0);
          UNTIL NEXT = 0;
      END;
    END;

    LOCAL PROCEDURE GetTransOrderSupplyEntries@1012(VAR AvailabilityCalcOverview@1000 : Record 5830);
    VAR
      TransLine@1001 : Record 5741;
      TransHeader@1002 : Record 5740;
    BEGIN
      WITH TransLine DO BEGIN
        IF FindLinesWithItemToPlan(Item,TRUE,FALSE) THEN
          REPEAT
            TransHeader.GET("Document No.");
            CALCFIELDS("Reserved Qty. Inbnd. (Base)");
            InsertEntry(
              AvailabilityCalcOverview,
              AvailabilityCalcOverview.Type::Supply,"Receipt Date","Transfer-to Code","Variant Code",
              "Outstanding Qty. (Base)","Reserved Qty. Inbnd. (Base)",
              DATABASE::"Transfer Line",Status,"Document No.",TransHeader."Transfer-from Name",0);
          UNTIL NEXT = 0;
      END;
    END;

    LOCAL PROCEDURE GetAsmOrderSupplyEntries@17(VAR AvailabilityCalcOverview@1000 : Record 5830);
    VAR
      AsmHeader@1001 : Record 900;
    BEGIN
      WITH AsmHeader DO BEGIN
        IF FindLinesWithItemToPlan(Item,"Document Type"::Order) THEN
          REPEAT
            CALCFIELDS("Reserved Qty. (Base)");
            InsertEntry(
              AvailabilityCalcOverview,
              AvailabilityCalcOverview.Type::Supply,"Due Date","Location Code","Variant Code",
              "Remaining Quantity (Base)","Reserved Qty. (Base)",
              DATABASE::"Assembly Header","Document Type",
              "No.",Description,0);
          UNTIL NEXT = 0;
      END;
    END;

    LOCAL PROCEDURE GetSalesOrdersDemandEntries@1017(VAR AvailabilityCalcOverview@1000 : Record 5830);
    VAR
      SalesLine@1001 : Record 37;
      SalesHeader@1002 : Record 36;
    BEGIN
      WITH SalesLine DO BEGIN
        IF FindLinesWithItemToPlan(Item,"Document Type"::Order) THEN
          REPEAT
            SalesHeader.GET("Document Type","Document No.");
            CALCFIELDS("Reserved Qty. (Base)");
            InsertEntry(
              AvailabilityCalcOverview,
              AvailabilityCalcOverview.Type::Demand,"Shipment Date","Location Code","Variant Code",
              -"Outstanding Qty. (Base)",-"Reserved Qty. (Base)",
              DATABASE::"Sales Line","Document Type","Document No.",SalesHeader."Sell-to Customer Name",DemandType::Sales);
          UNTIL NEXT = 0;
      END;
    END;

    LOCAL PROCEDURE GetServOrdersDemandEntries@3(VAR AvailabilityCalcOverview@1000 : Record 5830);
    VAR
      ServLine@1001 : Record 5902;
      ServHeader@1002 : Record 5900;
    BEGIN
      WITH ServLine DO BEGIN
        IF FindLinesWithItemToPlan(Item) THEN
          REPEAT
            ServHeader.GET("Document Type","Document No.");
            CALCFIELDS("Reserved Qty. (Base)");
            InsertEntry(
              AvailabilityCalcOverview,
              AvailabilityCalcOverview.Type::Demand,"Needed by Date","Location Code","Variant Code",
              -"Outstanding Qty. (Base)",-"Reserved Qty. (Base)",
              DATABASE::"Service Line","Document Type","Document No.",ServHeader."Ship-to Name",DemandType::Service);
          UNTIL NEXT = 0;
      END;
    END;

    LOCAL PROCEDURE GetJobOrdersDemandEntries@4(VAR AvailabilityCalcOverview@1000 : Record 5830);
    VAR
      JobPlanningLine@1001 : Record 1003;
      Job@1002 : Record 167;
    BEGIN
      WITH JobPlanningLine DO BEGIN
        IF FindLinesWithItemToPlan(Item) THEN
          REPEAT
            Job.GET("Job No.");
            CALCFIELDS("Reserved Qty. (Base)");
            InsertEntry(
              AvailabilityCalcOverview,
              AvailabilityCalcOverview.Type::Demand,"Planning Date","Location Code","Variant Code",
              -"Remaining Qty. (Base)",-"Reserved Qty. (Base)",
              DATABASE::"Job Planning Line",Status,"Job No.",Job."Bill-to Name",DemandType::Job);
          UNTIL NEXT = 0;
      END;
    END;

    LOCAL PROCEDURE GetPurchRetOrderDemandEntries@1016(VAR AvailabilityCalcOverview@1000 : Record 5830);
    VAR
      PurchLine@1001 : Record 39;
      PurchHeader@1002 : Record 38;
    BEGIN
      WITH PurchLine DO BEGIN
        IF FindLinesWithItemToPlan(Item,"Document Type"::"Return Order") THEN
          REPEAT
            PurchHeader.GET("Document Type","Document No.");
            CALCFIELDS("Reserved Qty. (Base)");
            InsertEntry(
              AvailabilityCalcOverview,
              AvailabilityCalcOverview.Type::Demand,"Expected Receipt Date","Location Code","Variant Code",
              -"Outstanding Qty. (Base)",-"Reserved Qty. (Base)",
              DATABASE::"Purchase Line","Document Type","Document No.",PurchHeader."Buy-from Vendor Name",0);
          UNTIL NEXT = 0;
      END;
    END;

    LOCAL PROCEDURE GetProdOrderCompDemandEntries@1013(VAR AvailabilityCalcOverview@1000 : Record 5830);
    VAR
      ProdOrderComp@1001 : Record 5407;
      ProdOrder@1002 : Record 5405;
    BEGIN
      WITH ProdOrderComp DO BEGIN
        IF FindLinesWithItemToPlan(Item,TRUE) THEN
          REPEAT
            ProdOrder.GET(Status,"Prod. Order No.");
            CALCFIELDS("Reserved Qty. (Base)");
            InsertEntry(
              AvailabilityCalcOverview,
              AvailabilityCalcOverview.Type::Demand,"Due Date","Location Code","Variant Code",
              -"Remaining Qty. (Base)",-"Reserved Qty. (Base)",
              DATABASE::"Prod. Order Component",Status,"Prod. Order No.",ProdOrder.Description,DemandType::Production);
          UNTIL NEXT = 0;
      END;
    END;

    LOCAL PROCEDURE GetTransOrderDemandEntries@1011(VAR AvailabilityCalcOverview@1000 : Record 5830);
    VAR
      TransLine@1001 : Record 5741;
      TransHeader@1002 : Record 5740;
    BEGIN
      WITH TransLine DO BEGIN
        IF FindLinesWithItemToPlan(Item,FALSE,FALSE) THEN
          REPEAT
            TransHeader.GET("Document No.");
            CALCFIELDS("Reserved Qty. Outbnd. (Base)");
            InsertEntry(
              AvailabilityCalcOverview,
              AvailabilityCalcOverview.Type::Demand,"Shipment Date","Transfer-from Code","Variant Code",
              -"Outstanding Qty. (Base)",-"Reserved Qty. Outbnd. (Base)",
              DATABASE::"Transfer Line",Status,"Document No.",TransHeader."Transfer-to Name",0);
          UNTIL NEXT = 0;
      END;
    END;

    LOCAL PROCEDURE GetAsmOrderDemandEntries@22(VAR AvailabilityCalcOverview@1000 : Record 5830);
    VAR
      AsmHeader@1001 : Record 900;
      AsmLine@1002 : Record 901;
    BEGIN
      WITH AsmLine DO BEGIN
        IF FindLinesWithItemToPlan(Item,"Document Type"::Order) THEN
          REPEAT
            AsmHeader.GET("Document Type","Document No.");
            CALCFIELDS("Reserved Qty. (Base)");
            InsertEntry(
              AvailabilityCalcOverview,
              AvailabilityCalcOverview.Type::Demand,"Due Date","Location Code","Variant Code",
              -"Remaining Quantity (Base)",-"Reserved Qty. (Base)",
              DATABASE::"Assembly Line","Document Type",
              "Document No.",AsmHeader.Description,DemandType::Assembly);
          UNTIL NEXT = 0;
      END;
    END;

    LOCAL PROCEDURE PurchOrderSupplyExists@1030(VAR Item@1002 : Record 27) : Boolean;
    VAR
      PurchLine@1001 : Record 39;
    BEGIN
      EXIT(PurchLine.LinesWithItemToPlanExist(Item,PurchLine."Document Type"::Order));
    END;

    LOCAL PROCEDURE SalesRetOrderSupplyExists@1029(VAR Item@1002 : Record 27) : Boolean;
    VAR
      SalesLine@1001 : Record 37;
    BEGIN
      EXIT(SalesLine.LinesWithItemToPlanExist(Item,SalesLine."Document Type"::"Return Order"));
    END;

    LOCAL PROCEDURE ProdOrderSupplyExists@1028(VAR Item@1002 : Record 27) : Boolean;
    VAR
      ProdOrderLine@1001 : Record 5406;
    BEGIN
      EXIT(ProdOrderLine.LinesWithItemToPlanExist(Item,TRUE));
    END;

    LOCAL PROCEDURE TransOrderSupplyExists@1027(VAR Item@1000 : Record 27) : Boolean;
    VAR
      TransLine@1001 : Record 5741;
    BEGIN
      EXIT(TransLine.LinesWithItemToPlanExist(Item,TRUE));
    END;

    LOCAL PROCEDURE AsmOrderSupplyExists@7(VAR Item@1000 : Record 27) : Boolean;
    VAR
      AsmHeader@1001 : Record 900;
    BEGIN
      EXIT(AsmHeader.LinesWithItemToPlanExist(Item,AsmHeader."Document Type"::Order));
    END;

    LOCAL PROCEDURE SalesOrderDemandExists@1026(VAR Item@1000 : Record 27) : Boolean;
    VAR
      SalesLine@1001 : Record 37;
    BEGIN
      EXIT(SalesLine.LinesWithItemToPlanExist(Item,SalesLine."Document Type"::Order));
    END;

    LOCAL PROCEDURE ServOrderDemandExists@14(VAR Item@1000 : Record 27) : Boolean;
    VAR
      ServLine@1001 : Record 5902;
    BEGIN
      EXIT(ServLine.LinesWithItemToPlanExist(Item));
    END;

    LOCAL PROCEDURE JobOrderDemandExists@15(VAR Item@1000 : Record 27) : Boolean;
    VAR
      JobPlanningLine@1001 : Record 1003;
    BEGIN
      EXIT(JobPlanningLine.LinesWithItemToPlanExist(Item));
    END;

    LOCAL PROCEDURE PurchRetOrderDemandExists@1025(VAR Item@1000 : Record 27) : Boolean;
    VAR
      PurchLine@1001 : Record 39;
    BEGIN
      EXIT(PurchLine.LinesWithItemToPlanExist(Item,PurchLine."Document Type"::"Return Order"));
    END;

    LOCAL PROCEDURE ProdOrderCompDemandExists@1021(VAR Item@1000 : Record 27) : Boolean;
    VAR
      ProdOrderComp@1001 : Record 5407;
    BEGIN
      EXIT(ProdOrderComp.LinesWithItemToPlanExist(Item,TRUE));
    END;

    LOCAL PROCEDURE TransOrderDemandExists@1001(VAR Item@1000 : Record 27) : Boolean;
    VAR
      TransLine@1001 : Record 5741;
    BEGIN
      EXIT(TransLine.LinesWithItemToPlanExist(Item,FALSE));
    END;

    LOCAL PROCEDURE AsmOrderDemandExists@6(VAR Item@1000 : Record 27) : Boolean;
    VAR
      AsmLine@1001 : Record 901;
    BEGIN
      EXIT(AsmLine.LinesWithItemToPlanExist(Item,AsmLine."Document Type"::Order));
    END;

    LOCAL PROCEDURE ClosingEntryExists@1038(VAR AvailabilityCalcOverview@1000 : Record 5830;NewType@1001 : Option;LocationCode@1002 : Code[20];VariantCode@1003 : Code[20];ClosingDate@1004 : Date) Found : Boolean;
    VAR
      CopyOfAvailabilityCalcOverview@1005 : Record 5830;
    BEGIN
      WITH AvailabilityCalcOverview DO BEGIN
        CopyOfAvailabilityCalcOverview.COPY(AvailabilityCalcOverview);
        SETRANGE("Item No.",Item."No.");
        SETRANGE("Location Code",LocationCode);
        SETRANGE("Variant Code",VariantCode);
        SETRANGE(Date,ClosingDate);
        SETRANGE(Type,NewType);
        Found := FINDFIRST;
        COPYFILTERS(CopyOfAvailabilityCalcOverview);
      END;
    END;

    LOCAL PROCEDURE CheckItemInRange@1039(VAR AvailabilityCalcOverview@1000 : Record 5830) : Boolean;
    VAR
      Item@1005 : Record 27;
      SalesLine@1001 : Record 37;
      ServLine@1002 : Record 5902;
      JobPlanningLine@1003 : Record 1003;
      ProdOrderComp@1004 : Record 5407;
      AsmLine@1007 : Record 901;
      Found@1006 : Boolean;
    BEGIN
      Item.GET(AvailabilityCalcOverview."Item No.");
      Item.SETFILTER("Location Filter",AvailabilityCalcOverview.GETFILTER("Location Code"));
      Item.SETFILTER("Variant Filter",AvailabilityCalcOverview.GETFILTER("Variant Code"));
      Item.SETFILTER("Date Filter",AvailabilityCalcOverview.GETFILTER(Date));

      CASE DemandType OF
        DemandType::" ":
          Found := DemandExists(Item);
        DemandType::Sales:
          WITH SalesLine DO
            IF LinesWithItemToPlanExist(Item,"Document Type"::Order) THEN BEGIN
              IF DemandNo <> '' THEN BEGIN
                SETRANGE("Document No.",DemandNo);
                Found := NOT ISEMPTY;
              END ELSE
                Found := TRUE;
            END;
        DemandType::Production:
          WITH ProdOrderComp DO
            IF LinesWithItemToPlanExist(Item,TRUE) THEN BEGIN
              IF DemandNo <> '' THEN BEGIN
                SETRANGE("Prod. Order No.",DemandNo);
                Found := NOT ISEMPTY;
              END ELSE
                Found := TRUE;
            END;
        DemandType::Service:
          WITH ServLine DO
            IF LinesWithItemToPlanExist(Item) THEN BEGIN
              IF DemandNo <> '' THEN BEGIN
                SETRANGE("Document No.",DemandNo);
                Found := NOT ISEMPTY;
              END ELSE
                Found := TRUE;
            END;
        DemandType::Job:
          WITH JobPlanningLine DO
            IF LinesWithItemToPlanExist(Item) THEN BEGIN
              IF DemandNo <> '' THEN BEGIN
                SETRANGE("Job No.",DemandNo);
                Found := NOT ISEMPTY;
              END ELSE
                Found := TRUE;
            END;
        DemandType::Assembly:
          WITH AsmLine DO
            IF LinesWithItemToPlanExist(Item,"Document Type"::Order) THEN BEGIN
              IF DemandNo <> '' THEN BEGIN
                SETRANGE("Document No.",DemandNo);
                Found := NOT ISEMPTY;
              END ELSE
                Found := TRUE;
            END;
      END;

      EXIT(Found);
    END;

    LOCAL PROCEDURE CheckDemandInDate@5(AvailCalcOverview@1005 : Record 5830) : Boolean;
    BEGIN
      AvailCalcOverview.SETRANGE("Location Code",AvailCalcOverview."Location Code");
      AvailCalcOverview.SETRANGE("Variant Code",AvailCalcOverview."Variant Code");
      AvailCalcOverview.SETRANGE(Date,AvailCalcOverview.Date);
      EXIT(CheckItemInRange(AvailCalcOverview));
    END;

    LOCAL PROCEDURE InsertEntry@1034(VAR AvailabilityCalcOverview@1000 : Record 5830;NewType@1001 : Integer;NewDate@1002 : Date;NewLocation@1003 : Code[10];NewVariantCode@1004 : Code[10];NewQuantityBase@1005 : Decimal;NewReservQtyBase@1012 : Decimal;NewSourceType@1006 : Integer;NewSourceOrderStatus@1007 : Integer;NewSourceID@1008 : Code[20];NewDescription@1009 : Text[50];NewDemandType@1010 : Option);
    VAR
      CopyOfItem@1011 : Record 27;
    BEGIN
      IF (NewDate <> 0D) AND NOT (NewDate IN [StartDate..EndDate]) THEN
        EXIT;
      CopyOfItem.COPY(Item);
      WITH AvailabilityCalcOverview DO BEGIN
        IF NewType IN [Type::"As of Date",Type::Inventory] THEN
          IF ClosingEntryExists(AvailabilityCalcOverview,NewType,NewLocation,NewVariantCode,NewDate) THEN BEGIN
            IF NOT "Matches Criteria" THEN BEGIN
              "Matches Criteria" := CheckDemandInDate(AvailabilityCalcOverview);
              MODIFY;
            END;
            EXIT;
          END;

        IF NOT (NewType IN [Type::Item,Type::"As of Date"]) THEN
          IF NewQuantityBase = 0 THEN
            EXIT;
        INIT;
        "Entry No." := GetEntryNo;
        Type := NewType;
        "Item No." := Item."No.";
        Date := NewDate;
        "Location Code" := NewLocation;
        "Variant Code" := NewVariantCode;
        Quantity := NewQuantityBase;
        "Reserved Quantity" := NewReservQtyBase;

        IF (DemandType = DemandType::" ") OR
           (Type = Type::"As of Date") OR
           ((DemandType = NewDemandType) AND (DemandNo IN ['',NewSourceID]))
        THEN
          "Matches Criteria" := NewDate IN [StartDate..EndDate];

        CASE NewType OF
          Type::Item:
            BEGIN
              Level := 0;
              "Matches Criteria" := TRUE;
            END;
          Type::Inventory:
            BEGIN
              "Attached to Entry No." := "Entry No.";
              Level := 1;
              "Inventory Running Total" := Quantity;
              "Running Total" := Quantity;
            END;
          Type::"As of Date",Type::Inventory:
            BEGIN
              "Attached to Entry No." := "Entry No.";
              Level := 1;
              CalcRunningTotals(
                Item."No.",NewLocation,NewVariantCode,NewDate,
                "Running Total","Inventory Running Total","Supply Running Total","Demand Running Total");
              AllocateToDemand("Inventory Running Total","Supply Running Total","Demand Running Total");
              IF "Matches Criteria" THEN
                "Matches Criteria" := CheckDemandInDate(AvailabilityCalcOverview);
            END;
          ELSE
            "Attached to Entry No." := AttachedToEntryNo;
            Level := 2;
        END;
        "Source Type" := NewSourceType;
        "Source Order Status" := NewSourceOrderStatus;
        "Source ID" := NewSourceID;
        Description := NewDescription;

        INSERT;
      END;
      Item.COPY(CopyOfItem);
    END;

    LOCAL PROCEDURE CalcRunningTotals@19(NewItem@1000 : Code[20];NewLocation@1001 : Code[10];NewVariant@1002 : Code[10];NewDate@1003 : Date;VAR RunningTotal@1004 : Decimal;VAR InventoryRunningTotal@1005 : Decimal;VAR SupplyRunningTotal@1007 : Decimal;VAR DemandRunningTotal@1006 : Decimal);
    VAR
      Item@1008 : Record 27;
    BEGIN
      WITH Item DO BEGIN
        GET(NewItem);
        SETRANGE("Location Filter",NewLocation);
        SETRANGE("Variant Filter",NewVariant);
        SETRANGE("Date Filter",0D,NewDate);
        CALCFIELDS(
          "Reserved Qty. on Purch. Orders",
          "Reserved Qty. on Prod. Order",
          "Res. Qty. on Inbound Transfer",
          "Reserved Qty. on Sales Orders",
          "Res. Qty. on Service Orders",
          "Res. Qty. on Job Order",
          "Res. Qty. on Prod. Order Comp.",
          "Res. Qty. on Outbound Transfer",
          "Reserved Qty. on Inventory",
          "Res. Qty. on Assembly Order",
          "Res. Qty. on  Asm. Comp.",
          "Res. Qty. on Sales Returns",
          "Res. Qty. on Purch. Returns");
        CALCFIELDS(
          "Qty. on Purch. Order",
          "Scheduled Receipt (Qty.)",
          "Planned Order Receipt (Qty.)",
          "Trans. Ord. Receipt (Qty.)",
          "Qty. on Sales Order",
          "Qty. on Service Order",
          "Qty. on Job Order",
          "Scheduled Need (Qty.)",
          "Trans. Ord. Shipment (Qty.)",
          Inventory,
          "Qty. on Assembly Order",
          "Qty. on Asm. Component",
          "Qty. on Purch. Return",
          "Qty. on Sales Return");

        SupplyRunningTotal :=
          "Qty. on Purch. Order" - "Reserved Qty. on Purch. Orders" +
          "Qty. on Sales Return" - "Res. Qty. on Sales Returns" +
          "Scheduled Receipt (Qty.)" + "Planned Order Receipt (Qty.)" - "Reserved Qty. on Prod. Order" +
          "Trans. Ord. Receipt (Qty.)" - "Res. Qty. on Inbound Transfer" +
          "Qty. on Assembly Order" - "Res. Qty. on Assembly Order";
        DemandRunningTotal :=
          -"Qty. on Sales Order" + "Reserved Qty. on Sales Orders" -
          "Qty. on Purch. Return" + "Res. Qty. on Purch. Returns" -
          "Scheduled Need (Qty.)" + "Res. Qty. on Prod. Order Comp." -
          "Qty. on Service Order" + "Res. Qty. on Service Orders" -
          "Qty. on Job Order" + "Res. Qty. on Job Order" -
          "Trans. Ord. Shipment (Qty.)" + "Res. Qty. on Outbound Transfer" -
          "Qty. on Asm. Component" + "Res. Qty. on  Asm. Comp.";
        InventoryRunningTotal := Inventory - "Reserved Qty. on Inventory";

        RunningTotal := InventoryRunningTotal + SupplyRunningTotal + DemandRunningTotal;
      END;
    END;

    LOCAL PROCEDURE UpdateRunningTotals@16(VAR AvailabilityCalcOverview@1000 : Record 5830);
    VAR
      CopyOfAvailCalcOverview@1007 : Record 5830;
      FirstEntryNo@1006 : Integer;
      RunningTotal@1005 : Decimal;
      SupplyRunningTotal@1004 : Decimal;
      DemandRunningTotal@1003 : Decimal;
      InventoryRunningTotal@1002 : Decimal;
    BEGIN
      CopyOfAvailCalcOverview.COPY(AvailabilityCalcOverview);
      WITH AvailabilityCalcOverview DO BEGIN
        FirstEntryNo := "Entry No.";
        IF Date <> 0D THEN
          CalcRunningTotals(
            "Item No.","Location Code","Variant Code",CALCDATE('<-1D>',Date),
            RunningTotal,InventoryRunningTotal,SupplyRunningTotal,DemandRunningTotal);

        REPEAT
          RunningTotal += Quantity - "Reserved Quantity";
          CASE Type OF
            Type::Inventory:
              InventoryRunningTotal += Quantity - "Reserved Quantity";
            Type::Supply,
            Type::"Supply Forecast":
              SupplyRunningTotal += Quantity - "Reserved Quantity";
            Type::Demand:
              DemandRunningTotal += Quantity - "Reserved Quantity";
          END;

          "Running Total" := RunningTotal;
          "Inventory Running Total" := InventoryRunningTotal;
          "Supply Running Total" := SupplyRunningTotal;
          "Demand Running Total" := DemandRunningTotal;
          AllocateToDemand("Inventory Running Total","Supply Running Total","Demand Running Total");
          IF DemandType = DemandType::" " THEN
            "Matches Criteria" := CopyOfAvailCalcOverview."Matches Criteria";

          MODIFY;
        UNTIL NEXT = 0;
        GET(FirstEntryNo);
        IF NEXT = 0 THEN;
      END;
    END;

    LOCAL PROCEDURE AllocateToDemand@27(VAR InventoryRunningTotal@1000 : Decimal;VAR SupplyRunningTotal@1001 : Decimal;VAR DemandRunningTotal@1002 : Decimal);
    VAR
      RemQty@1003 : Decimal;
    BEGIN
      RemQty := DemandRunningTotal;
      IF RemQty < 0 THEN
        IF InventoryRunningTotal > 0 THEN
          IF -RemQty > InventoryRunningTotal THEN BEGIN
            RemQty += InventoryRunningTotal;
            InventoryRunningTotal := 0;
          END ELSE BEGIN
            InventoryRunningTotal += RemQty;
            RemQty := 0;
          END;
      IF RemQty < 0 THEN
        IF SupplyRunningTotal > 0 THEN
          IF -RemQty > SupplyRunningTotal THEN BEGIN
            RemQty += SupplyRunningTotal;
            SupplyRunningTotal := 0;
          END ELSE BEGIN
            SupplyRunningTotal += RemQty;
            RemQty := 0;
          END;
      DemandRunningTotal := RemQty;
    END;

    LOCAL PROCEDURE GetEntryNo@1036() : Integer;
    BEGIN
      EntryNo += 1;
      EXIT(EntryNo);
    END;

    LOCAL PROCEDURE SetEntryNo@1057(NewEntryNo@1000 : Integer);
    BEGIN
      EntryNo := NewEntryNo;
    END;

    PROCEDURE SetParam@1042(NewDemandType@1000 : Option;NewDemandNo@1001 : Code[20]);
    BEGIN
      DemandType := NewDemandType;
      DemandNo := NewDemandNo;
    END;

    LOCAL PROCEDURE OpenWindow@12(DisplayText@1001 : Text[250];NoOfRecords2@1000 : Integer);
    BEGIN
      i := 0;
      NoOfRecords := NoOfRecords2;
      WindowUpdateDateTime := CURRENTDATETIME;
      Window.OPEN(DisplayText);
    END;

    LOCAL PROCEDURE UpdateWindow@2();
    BEGIN
      i := i + 1;
      IF CURRENTDATETIME - WindowUpdateDateTime >= 1000 THEN BEGIN
        WindowUpdateDateTime := CURRENTDATETIME;
        Window.UPDATE(1,ROUND(i / NoOfRecords * 10000,1));
      END;
    END;

    BEGIN
    END.
  }
}

